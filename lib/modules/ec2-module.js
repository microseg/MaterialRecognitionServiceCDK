"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.EC2Module = void 0;
const cdk = require("aws-cdk-lib");
const ec2 = require("aws-cdk-lib/aws-ec2");
const iam = require("aws-cdk-lib/aws-iam");
const constructs_1 = require("constructs");
class EC2Module extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        // Create IAM role for the EC2 instance
        this.instanceRole = new iam.Role(this, 'DeploymentInstanceRole', {
            assumedBy: new iam.ServicePrincipal('ec2.amazonaws.com'),
            managedPolicies: [
                iam.ManagedPolicy.fromAwsManagedPolicyName('AmazonSSMManagedInstanceCore'),
                iam.ManagedPolicy.fromAwsManagedPolicyName('CloudWatchAgentServerPolicy'),
            ],
        });
        // Add custom policy for S3 access (if needed for deployment artifacts)
        this.instanceRole.addToPolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                's3:GetObject',
                's3:GetObjectVersion',
                's3:ListBucket',
            ],
            resources: [
                'arn:aws:s3:::aws-codepipeline-*',
                'arn:aws:s3:::aws-codepipeline-*/*',
                'arn:aws:s3:::materialrecognitionservic-*',
                'arn:aws:s3:::materialrecognitionservic-*/*',
            ],
        }));
        // Add CodeDeploy permissions for the EC2 instance
        this.instanceRole.addToPolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                'codedeploy:*',
            ],
            resources: ['*'],
        }));
        // Create security group for the deployment instance
        const deploymentSecurityGroup = new ec2.SecurityGroup(this, 'DeploymentInstanceSecurityGroup', {
            vpc: props.vpc,
            description: 'Security group for Material Recognition Service deployment instance',
            allowAllOutbound: true,
        });
        // Allow SSH access from anywhere (for testing purposes)
        deploymentSecurityGroup.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(22), 'Allow SSH access');
        // Allow HTTP access for the application
        deploymentSecurityGroup.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(80), 'Allow HTTP access');
        // Allow HTTPS access for the application
        deploymentSecurityGroup.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(443), 'Allow HTTPS access');
        // Allow application port (assuming Flask app runs on 5000)
        deploymentSecurityGroup.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(5000), 'Allow application access');
        // Create user data script for instance initialization
        const userData = ec2.UserData.forLinux();
        userData.addCommands('#!/bin/bash', 'yum update -y', 'yum install -y git python3 python3-pip nginx wget', 'systemctl enable nginx', 'systemctl start nginx', '', '# Create application directory', 'mkdir -p /opt/material-recognition-service', 'chown ec2-user:ec2-user /opt/material-recognition-service', '', '# Install Python dependencies', 'pip3 install flask gunicorn', '', '# Install CodeDeploy agent', 'yum install -y ruby wget', 'cd /home/ec2-user', 'wget https://aws-codedeploy-${AWS::Region}.s3.${AWS::Region}.amazonaws.com/latest/install', 'chmod +x ./install', './install auto', 'systemctl enable codedeploy-agent', 'systemctl start codedeploy-agent', '', '# Configure nginx as reverse proxy', 'cat > /etc/nginx/conf.d/material-recognition.conf << EOF', 'server {', '    listen 80;', '    server_name _;', '    location / {', '        proxy_pass http://127.0.0.1:5000;', '        proxy_set_header Host $host;', '        proxy_set_header X-Real-IP $remote_addr;', '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;', '        proxy_set_header X-Forwarded-Proto $scheme;', '        proxy_connect_timeout 300s;', '        proxy_send_timeout 300s;', '        proxy_read_timeout 300s;', '    }', '}', 'EOF', '', '# Reload nginx configuration', 'nginx -t && systemctl reload nginx', '', '# Create systemd service for the application', 'cat > /etc/systemd/system/material-recognition.service << EOF', '[Unit]', 'Description=Material Recognition Service', 'After=network.target', '', '[Service]', 'Type=simple', 'User=ec2-user', 'WorkingDirectory=/opt/material-recognition-service', 'Environment=PATH=/usr/local/bin:/usr/bin:/bin', 'ExecStart=/usr/local/bin/gunicorn -w 4 -b 0.0.0.0:5000 --timeout 300 app:app', 'Restart=always', 'RestartSec=10', '', '[Install]', 'WantedBy=multi-user.target', 'EOF', '', '# Create a simple test application to verify the setup', 'cat > /opt/material-recognition-service/app.py << EOF', 'from flask import Flask', 'app = Flask(__name__)', '', '@app.route("/")', 'def hello():', '    return "Material Recognition Service is running!"', '', '@app.route("/health")', 'def health():', '    return {"status": "healthy"}, 200', '', '@app.route("/add/<int:a>/<int:b>")', 'def add(a, b):', '    return {"result": a + b}, 200', '', 'if __name__ == "__main__":', '    app.run(host="0.0.0.0", port=5000, debug=True)', 'EOF', '', '# Set proper permissions', 'chown -R ec2-user:ec2-user /opt/material-recognition-service/', 'chmod +x /opt/material-recognition-service/app.py', '', '# Create requirements.txt', 'cat > /opt/material-recognition-service/requirements.txt << EOF', 'Flask==2.3.3', 'gunicorn==21.2.0', 'EOF', '', '# Install Python dependencies', 'cd /opt/material-recognition-service/', 'pip3 install -r requirements.txt', '', '# Enable and start the service', 'systemctl enable material-recognition.service', 'systemctl start material-recognition.service', '', '# Wait for service to start', 'sleep 10', '', '# Test the application', 'curl -f http://localhost:5000/health || echo "Application not ready yet"');
        // Create the EC2 instance
        this.deploymentInstance = new ec2.Instance(this, 'DeploymentInstance', {
            vpc: props.vpc,
            vpcSubnets: {
                subnetType: ec2.SubnetType.PUBLIC,
            },
            instanceType: ec2.InstanceType.of(ec2.InstanceClass.T3, ec2.InstanceSize.MICRO),
            machineImage: new ec2.AmazonLinuxImage({
                generation: ec2.AmazonLinuxGeneration.AMAZON_LINUX_2,
            }),
            // keyName: props.keyName, // Removed to avoid key pair dependency
            role: this.instanceRole,
            securityGroup: deploymentSecurityGroup,
            userData: userData,
            blockDevices: [
                {
                    deviceName: '/dev/xvda',
                    volume: ec2.BlockDeviceVolume.ebs(20, {
                        volumeType: ec2.EbsDeviceVolumeType.GP3,
                        deleteOnTermination: true,
                    }),
                },
            ],
        });
        // Tag the instance
        cdk.Tags.of(this.deploymentInstance).add('Project', 'MaterialRecognitionService');
        cdk.Tags.of(this.deploymentInstance).add('Environment', 'Development');
        cdk.Tags.of(this.deploymentInstance).add('Purpose', 'Deployment');
    }
}
exports.EC2Module = EC2Module;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWMyLW1vZHVsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImVjMi1tb2R1bGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbUNBQW1DO0FBQ25DLDJDQUEyQztBQUMzQywyQ0FBMkM7QUFDM0MsMkNBQXVDO0FBUXZDLE1BQWEsU0FBVSxTQUFRLHNCQUFTO0lBSXRDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBcUI7UUFDN0QsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQix1Q0FBdUM7UUFDdkMsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLHdCQUF3QixFQUFFO1lBQy9ELFNBQVMsRUFBRSxJQUFJLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxtQkFBbUIsQ0FBQztZQUN4RCxlQUFlLEVBQUU7Z0JBQ2YsR0FBRyxDQUFDLGFBQWEsQ0FBQyx3QkFBd0IsQ0FBQyw4QkFBOEIsQ0FBQztnQkFDMUUsR0FBRyxDQUFDLGFBQWEsQ0FBQyx3QkFBd0IsQ0FBQyw2QkFBNkIsQ0FBQzthQUMxRTtTQUNGLENBQUMsQ0FBQztRQUVILHVFQUF1RTtRQUN2RSxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FDM0IsSUFBSSxHQUFHLENBQUMsZUFBZSxDQUFDO1lBQ3RCLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUs7WUFDeEIsT0FBTyxFQUFFO2dCQUNQLGNBQWM7Z0JBQ2QscUJBQXFCO2dCQUNyQixlQUFlO2FBQ2hCO1lBQ0QsU0FBUyxFQUFFO2dCQUNULGlDQUFpQztnQkFDakMsbUNBQW1DO2dCQUNuQywwQ0FBMEM7Z0JBQzFDLDRDQUE0QzthQUM3QztTQUNGLENBQUMsQ0FDSCxDQUFDO1FBRUYsa0RBQWtEO1FBQ2xELElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUMzQixJQUFJLEdBQUcsQ0FBQyxlQUFlLENBQUM7WUFDdEIsTUFBTSxFQUFF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QkFDWjtvQkFDRSxVQUFVLEVBQUUsV0FBVztvQkFDdkIsTUFBTSxFQUFFLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFO3dCQUNwQyxVQUFVLEVBQUUsR0FBRyxDQUFDLG1CQUFtQixDQUFDLEdBQUc7d0JBQ3ZDLG1CQUFtQixFQUFFLElBQUk7cUJBQzFCLENBQUM7aUJBQ0g7YUFDRjtTQUNGLENBQUMsQ0FBQztRQUVILG1CQUFtQjtRQUNuQixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLDRCQUE0QixDQUFDLENBQUM7UUFDbEYsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUN2RSxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLFlBQVksQ0FBQyxDQUFDO0lBQ3BFLENBQUM7Q0FDRjtBQWhPRCw4QkFnT0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0ICogYXMgZWMyIGZyb20gJ2F3cy1jZGstbGliL2F3cy1lYzInO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRUMyTW9kdWxlUHJvcHMge1xuICB2cGM6IGVjMi5JVnBjO1xuICBpbnN0YW5jZVR5cGU/OiBzdHJpbmc7XG4gIGtleU5hbWU/OiBzdHJpbmc7IC8vIE1hZGUgb3B0aW9uYWxcbn1cblxuZXhwb3J0IGNsYXNzIEVDMk1vZHVsZSBleHRlbmRzIENvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBkZXBsb3ltZW50SW5zdGFuY2U6IGVjMi5JbnN0YW5jZTtcbiAgcHVibGljIHJlYWRvbmx5IGluc3RhbmNlUm9sZTogaWFtLlJvbGU7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IEVDMk1vZHVsZVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIC8vIENyZWF0ZSBJQU0gcm9sZSBmb3IgdGhlIEVDMiBpbnN0YW5jZVxuICAgIHRoaXMuaW5zdGFuY2VSb2xlID0gbmV3IGlhbS5Sb2xlKHRoaXMsICdEZXBsb3ltZW50SW5zdGFuY2VSb2xlJywge1xuICAgICAgYXNzdW1lZEJ5OiBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoJ2VjMi5hbWF6b25hd3MuY29tJyksXG4gICAgICBtYW5hZ2VkUG9saWNpZXM6IFtcbiAgICAgICAgaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKCdBbWF6b25TU01NYW5hZ2VkSW5zdGFuY2VDb3JlJyksXG4gICAgICAgIGlhbS5NYW5hZ2VkUG9saWN5LmZyb21Bd3NNYW5hZ2VkUG9saWN5TmFtZSgnQ2xvdWRXYXRjaEFnZW50U2VydmVyUG9saWN5JyksXG4gICAgICBdLFxuICAgIH0pO1xuXG4gICAgLy8gQWRkIGN1c3RvbSBwb2xpY3kgZm9yIFMzIGFjY2VzcyAoaWYgbmVlZGVkIGZvciBkZXBsb3ltZW50IGFydGlmYWN0cylcbiAgICB0aGlzLmluc3RhbmNlUm9sZS5hZGRUb1BvbGljeShcbiAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgJ3MzOkdldE9iamVjdCcsXG4gICAgICAgICAgJ3MzOkdldE9iamVjdFZlcnNpb24nLFxuICAgICAgICAgICdzMzpMaXN0QnVja2V0JyxcbiAgICAgICAgXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbXG4gICAgICAgICAgJ2Fybjphd3M6czM6Ojphd3MtY29kZXBpcGVsaW5lLSonLFxuICAgICAgICAgICdhcm46YXdzOnMzOjo6YXdzLWNvZGVwaXBlbGluZS0qLyonLFxuICAgICAgICAgICdhcm46YXdzOnMzOjo6bWF0ZXJpYWxyZWNvZ25pdGlvbnNlcnZpYy0qJyxcbiAgICAgICAgICAnYXJuOmF3czpzMzo6Om1hdGVyaWFscmVjb2duaXRpb25zZXJ2aWMtKi8qJyxcbiAgICAgICAgXSxcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIC8vIEFkZCBDb2RlRGVwbG95IHBlcm1pc3Npb25zIGZvciB0aGUgRUMyIGluc3RhbmNlXG4gICAgdGhpcy5pbnN0YW5jZVJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgICdjb2RlZGVwbG95OionLFxuICAgICAgICBdLFxuICAgICAgICByZXNvdXJjZXM6IFsnKiddLFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgLy8gQ3JlYXRlIHNlY3VyaXR5IGdyb3VwIGZvciB0aGUgZGVwbG95bWVudCBpbnN0YW5jZVxuICAgIGNvbnN0IGRlcGxveW1lbnRTZWN1cml0eUdyb3VwID0gbmV3IGVjMi5TZWN1cml0eUdyb3VwKHRoaXMsICdEZXBsb3ltZW50SW5zdGFuY2VTZWN1cml0eUdyb3VwJywge1xuICAgICAgdnBjOiBwcm9wcy52cGMsXG4gICAgICBkZXNjcmlwdGlvbjogJ1NlY3VyaXR5IGdyb3VwIGZvciBNYXRlcmlhbCBSZWNvZ25pdGlvbiBTZXJ2aWNlIGRlcGxveW1lbnQgaW5zdGFuY2UnLFxuICAgICAgYWxsb3dBbGxPdXRib3VuZDogdHJ1ZSxcbiAgICB9KTtcblxuICAgIC8vIEFsbG93IFNTSCBhY2Nlc3MgZnJvbSBhbnl3aGVyZSAoZm9yIHRlc3RpbmcgcHVycG9zZXMpXG4gICAgZGVwbG95bWVudFNlY3VyaXR5R3JvdXAuYWRkSW5ncmVzc1J1bGUoXG4gICAgICBlYzIuUGVlci5hbnlJcHY0KCksXG4gICAgICBlYzIuUG9ydC50Y3AoMjIpLFxuICAgICAgJ0FsbG93IFNTSCBhY2Nlc3MnXG4gICAgKTtcblxuICAgIC8vIEFsbG93IEhUVFAgYWNjZXNzIGZvciB0aGUgYXBwbGljYXRpb25cbiAgICBkZXBsb3ltZW50U2VjdXJpdHlHcm91cC5hZGRJbmdyZXNzUnVsZShcbiAgICAgIGVjMi5QZWVyLmFueUlwdjQoKSxcbiAgICAgIGVjMi5Qb3J0LnRjcCg4MCksXG4gICAgICAnQWxsb3cgSFRUUCBhY2Nlc3MnXG4gICAgKTtcblxuICAgIC8vIEFsbG93IEhUVFBTIGFjY2VzcyBmb3IgdGhlIGFwcGxpY2F0aW9uXG4gICAgZGVwbG95bWVudFNlY3VyaXR5R3JvdXAuYWRkSW5ncmVzc1J1bGUoXG4gICAgICBlYzIuUGVlci5hbnlJcHY0KCksXG4gICAgICBlYzIuUG9ydC50Y3AoNDQzKSxcbiAgICAgICdBbGxvdyBIVFRQUyBhY2Nlc3MnXG4gICAgKTtcblxuICAgIC8vIEFsbG93IGFwcGxpY2F0aW9uIHBvcnQgKGFzc3VtaW5nIEZsYXNrIGFwcCBydW5zIG9uIDUwMDApXG4gICAgZGVwbG95bWVudFNlY3VyaXR5R3JvdXAuYWRkSW5ncmVzc1J1bGUoXG4gICAgICBlYzIuUGVlci5hbnlJcHY0KCksXG4gICAgICBlYzIuUG9ydC50Y3AoNTAwMCksXG4gICAgICAnQWxsb3cgYXBwbGljYXRpb24gYWNjZXNzJ1xuICAgICk7XG5cbiAgICAvLyBDcmVhdGUgdXNlciBkYXRhIHNjcmlwdCBmb3IgaW5zdGFuY2UgaW5pdGlhbGl6YXRpb25cbiAgICBjb25zdCB1c2VyRGF0YSA9IGVjMi5Vc2VyRGF0YS5mb3JMaW51eCgpO1xuICAgIHVzZXJEYXRhLmFkZENvbW1hbmRzKFxuICAgICAgJyMhL2Jpbi9iYXNoJyxcbiAgICAgICd5dW0gdXBkYXRlIC15JyxcbiAgICAgICd5dW0gaW5zdGFsbCAteSBnaXQgcHl0aG9uMyBweXRob24zLXBpcCBuZ2lueCB3Z2V0JyxcbiAgICAgICdzeXN0ZW1jdGwgZW5hYmxlIG5naW54JyxcbiAgICAgICdzeXN0ZW1jdGwgc3RhcnQgbmdpbngnLFxuICAgICAgJycsXG4gICAgICAnIyBDcmVhdGUgYXBwbGljYXRpb24gZGlyZWN0b3J5JyxcbiAgICAgICdta2RpciAtcCAvb3B0L21hdGVyaWFsLXJlY29nbml0aW9uLXNlcnZpY2UnLFxuICAgICAgJ2Nob3duIGVjMi11c2VyOmVjMi11c2VyIC9vcHQvbWF0ZXJpYWwtcmVjb2duaXRpb24tc2VydmljZScsXG4gICAgICAnJyxcbiAgICAgICcjIEluc3RhbGwgUHl0aG9uIGRlcGVuZGVuY2llcycsXG4gICAgICAncGlwMyBpbnN0YWxsIGZsYXNrIGd1bmljb3JuJyxcbiAgICAgICcnLFxuICAgICAgJyMgSW5zdGFsbCBDb2RlRGVwbG95IGFnZW50JyxcbiAgICAgICd5dW0gaW5zdGFsbCAteSBydWJ5IHdnZXQnLFxuICAgICAgJ2NkIC9ob21lL2VjMi11c2VyJyxcbiAgICAgICd3Z2V0IGh0dHBzOi8vYXdzLWNvZGVkZXBsb3ktJHtBV1M6OlJlZ2lvbn0uczMuJHtBV1M6OlJlZ2lvbn0uYW1hem9uYXdzLmNvbS9sYXRlc3QvaW5zdGFsbCcsXG4gICAgICAnY2htb2QgK3ggLi9pbnN0YWxsJyxcbiAgICAgICcuL2luc3RhbGwgYXV0bycsXG4gICAgICAnc3lzdGVtY3RsIGVuYWJsZSBjb2RlZGVwbG95LWFnZW50JyxcbiAgICAgICdzeXN0ZW1jdGwgc3RhcnQgY29kZWRlcGxveS1hZ2VudCcsXG4gICAgICAnJyxcbiAgICAgICcjIENvbmZpZ3VyZSBuZ2lueCBhcyByZXZlcnNlIHByb3h5JyxcbiAgICAgICdjYXQgPiAvZXRjL25naW54L2NvbmYuZC9tYXRlcmlhbC1yZWNvZ25pdGlvbi5jb25mIDw8IEVPRicsXG4gICAgICAnc2VydmVyIHsnLFxuICAgICAgJyAgICBsaXN0ZW4gODA7JyxcbiAgICAgICcgICAgc2VydmVyX25hbWUgXzsnLFxuICAgICAgJyAgICBsb2NhdGlvbiAvIHsnLFxuICAgICAgJyAgICAgICAgcHJveHlfcGFzcyBodHRwOi8vMTI3LjAuMC4xOjUwMDA7JyxcbiAgICAgICcgICAgICAgIHByb3h5X3NldF9oZWFkZXIgSG9zdCAkaG9zdDsnLFxuICAgICAgJyAgICAgICAgcHJveHlfc2V0X2hlYWRlciBYLVJlYWwtSVAgJHJlbW90ZV9hZGRyOycsXG4gICAgICAnICAgICAgICBwcm94eV9zZXRfaGVhZGVyIFgtRm9yd2FyZGVkLUZvciAkcHJveHlfYWRkX3hfZm9yd2FyZGVkX2ZvcjsnLFxuICAgICAgJyAgICAgICAgcHJveHlfc2V0X2hlYWRlciBYLUZvcndhcmRlZC1Qcm90byAkc2NoZW1lOycsXG4gICAgICAnICAgICAgICBwcm94eV9jb25uZWN0X3RpbWVvdXQgMzAwczsnLFxuICAgICAgJyAgICAgICAgcHJveHlfc2VuZF90aW1lb3V0IDMwMHM7JyxcbiAgICAgICcgICAgICAgIHByb3h5X3JlYWRfdGltZW91dCAzMDBzOycsXG4gICAgICAnICAgIH0nLFxuICAgICAgJ30nLFxuICAgICAgJ0VPRicsXG4gICAgICAnJyxcbiAgICAgICcjIFJlbG9hZCBuZ2lueCBjb25maWd1cmF0aW9uJyxcbiAgICAgICduZ2lueCAtdCAmJiBzeXN0ZW1jdGwgcmVsb2FkIG5naW54JyxcbiAgICAgICcnLFxuICAgICAgJyMgQ3JlYXRlIHN5c3RlbWQgc2VydmljZSBmb3IgdGhlIGFwcGxpY2F0aW9uJyxcbiAgICAgICdjYXQgPiAvZXRjL3N5c3RlbWQvc3lzdGVtL21hdGVyaWFsLXJlY29nbml0aW9uLnNlcnZpY2UgPDwgRU9GJyxcbiAgICAgICdbVW5pdF0nLFxuICAgICAgJ0Rlc2NyaXB0aW9uPU1hdGVyaWFsIFJlY29nbml0aW9uIFNlcnZpY2UnLFxuICAgICAgJ0FmdGVyPW5ldHdvcmsudGFyZ2V0JyxcbiAgICAgICcnLFxuICAgICAgJ1tTZXJ2aWNlXScsXG4gICAgICAnVHlwZT1zaW1wbGUnLFxuICAgICAgJ1VzZXI9ZWMyLXVzZXInLFxuICAgICAgJ1dvcmtpbmdEaXJlY3Rvcnk9L29wdC9tYXRlcmlhbC1yZWNvZ25pdGlvbi1zZXJ2aWNlJyxcbiAgICAgICdFbnZpcm9ubWVudD1QQVRIPS91c3IvbG9jYWwvYmluOi91c3IvYmluOi9iaW4nLFxuICAgICAgJ0V4ZWNTdGFydD0vdXNyL2xvY2FsL2Jpbi9ndW5pY29ybiAtdyA0IC1iIDAuMC4wLjA6NTAwMCAtLXRpbWVvdXQgMzAwIGFwcDphcHAnLFxuICAgICAgJ1Jlc3RhcnQ9YWx3YXlzJyxcbiAgICAgICdSZXN0YXJ0U2VjPTEwJyxcbiAgICAgICcnLFxuICAgICAgJ1tJbnN0YWxsXScsXG4gICAgICAnV2FudGVkQnk9bXVsdGktdXNlci50YXJnZXQnLFxuICAgICAgJ0VPRicsXG4gICAgICAnJyxcbiAgICAgICcjIENyZWF0ZSBhIHNpbXBsZSB0ZXN0IGFwcGxpY2F0aW9uIHRvIHZlcmlmeSB0aGUgc2V0dXAnLFxuICAgICAgJ2NhdCA+IC9vcHQvbWF0ZXJpYWwtcmVjb2duaXRpb24tc2VydmljZS9hcHAucHkgPDwgRU9GJyxcbiAgICAgICdmcm9tIGZsYXNrIGltcG9ydCBGbGFzaycsXG4gICAgICAnYXBwID0gRmxhc2soX19uYW1lX18pJyxcbiAgICAgICcnLFxuICAgICAgJ0BhcHAucm91dGUoXCIvXCIpJyxcbiAgICAgICdkZWYgaGVsbG8oKTonLFxuICAgICAgJyAgICByZXR1cm4gXCJNYXRlcmlhbCBSZWNvZ25pdGlvbiBTZXJ2aWNlIGlzIHJ1bm5pbmchXCInLFxuICAgICAgJycsXG4gICAgICAnQGFwcC5yb3V0ZShcIi9oZWFsdGhcIiknLFxuICAgICAgJ2RlZiBoZWFsdGgoKTonLFxuICAgICAgJyAgICByZXR1cm4ge1wic3RhdHVzXCI6IFwiaGVhbHRoeVwifSwgMjAwJyxcbiAgICAgICcnLFxuICAgICAgJ0BhcHAucm91dGUoXCIvYWRkLzxpbnQ6YT4vPGludDpiPlwiKScsXG4gICAgICAnZGVmIGFkZChhLCBiKTonLFxuICAgICAgJyAgICByZXR1cm4ge1wicmVzdWx0XCI6IGEgKyBifSwgMjAwJyxcbiAgICAgICcnLFxuICAgICAgJ2lmIF9fbmFtZV9fID09IFwiX19tYWluX19cIjonLFxuICAgICAgJyAgICBhcHAucnVuKGhvc3Q9XCIwLjAuMC4wXCIsIHBvcnQ9NTAwMCwgZGVidWc9VHJ1ZSknLFxuICAgICAgJ0VPRicsXG4gICAgICAnJyxcbiAgICAgICcjIFNldCBwcm9wZXIgcGVybWlzc2lvbnMnLFxuICAgICAgJ2Nob3duIC1SIGVjMi11c2VyOmVjMi11c2VyIC9vcHQvbWF0ZXJpYWwtcmVjb2duaXRpb24tc2VydmljZS8nLFxuICAgICAgJ2NobW9kICt4IC9vcHQvbWF0ZXJpYWwtcmVjb2duaXRpb24tc2VydmljZS9hcHAucHknLFxuICAgICAgJycsXG4gICAgICAnIyBDcmVhdGUgcmVxdWlyZW1lbnRzLnR4dCcsXG4gICAgICAnY2F0ID4gL29wdC9tYXRlcmlhbC1yZWNvZ25pdGlvbi1zZXJ2aWNlL3JlcXVpcmVtZW50cy50eHQgPDwgRU9GJyxcbiAgICAgICdGbGFzaz09Mi4zLjMnLFxuICAgICAgJ2d1bmljb3JuPT0yMS4yLjAnLFxuICAgICAgJ0VPRicsXG4gICAgICAnJyxcbiAgICAgICcjIEluc3RhbGwgUHl0aG9uIGRlcGVuZGVuY2llcycsXG4gICAgICAnY2QgL29wdC9tYXRlcmlhbC1yZWNvZ25pdGlvbi1zZXJ2aWNlLycsXG4gICAgICAncGlwMyBpbnN0YWxsIC1yIHJlcXVpcmVtZW50cy50eHQnLFxuICAgICAgJycsXG4gICAgICAnIyBFbmFibGUgYW5kIHN0YXJ0IHRoZSBzZXJ2aWNlJyxcbiAgICAgICdzeXN0ZW1jdGwgZW5hYmxlIG1hdGVyaWFsLXJlY29nbml0aW9uLnNlcnZpY2UnLFxuICAgICAgJ3N5c3RlbWN0bCBzdGFydCBtYXRlcmlhbC1yZWNvZ25pdGlvbi5zZXJ2aWNlJyxcbiAgICAgICcnLFxuICAgICAgJyMgV2FpdCBmb3Igc2VydmljZSB0byBzdGFydCcsXG4gICAgICAnc2xlZXAgMTAnLFxuICAgICAgJycsXG4gICAgICAnIyBUZXN0IHRoZSBhcHBsaWNhdGlvbicsXG4gICAgICAnY3VybCAtZiBodHRwOi8vbG9jYWxob3N0OjUwMDAvaGVhbHRoIHx8IGVjaG8gXCJBcHBsaWNhdGlvbiBub3QgcmVhZHkgeWV0XCInXG4gICAgKTtcblxuICAgIC8vIENyZWF0ZSB0aGUgRUMyIGluc3RhbmNlXG4gICAgdGhpcy5kZXBsb3ltZW50SW5zdGFuY2UgPSBuZXcgZWMyLkluc3RhbmNlKHRoaXMsICdEZXBsb3ltZW50SW5zdGFuY2UnLCB7XG4gICAgICB2cGM6IHByb3BzLnZwYyxcbiAgICAgIHZwY1N1Ym5ldHM6IHtcbiAgICAgICAgc3VibmV0VHlwZTogZWMyLlN1Ym5ldFR5cGUuUFVCTElDLFxuICAgICAgfSxcbiAgICAgIGluc3RhbmNlVHlwZTogZWMyLkluc3RhbmNlVHlwZS5vZihcbiAgICAgICAgZWMyLkluc3RhbmNlQ2xhc3MuVDMsXG4gICAgICAgIGVjMi5JbnN0YW5jZVNpemUuTUlDUk9cbiAgICAgICksXG4gICAgICBtYWNoaW5lSW1hZ2U6IG5ldyBlYzIuQW1hem9uTGludXhJbWFnZSh7XG4gICAgICAgIGdlbmVyYXRpb246IGVjMi5BbWF6b25MaW51eEdlbmVyYXRpb24uQU1BWk9OX0xJTlVYXzIsXG4gICAgICB9KSxcbiAgICAgIC8vIGtleU5hbWU6IHByb3BzLmtleU5hbWUsIC8vIFJlbW92ZWQgdG8gYXZvaWQga2V5IHBhaXIgZGVwZW5kZW5jeVxuICAgICAgcm9sZTogdGhpcy5pbnN0YW5jZVJvbGUsXG4gICAgICBzZWN1cml0eUdyb3VwOiBkZXBsb3ltZW50U2VjdXJpdHlHcm91cCxcbiAgICAgIHVzZXJEYXRhOiB1c2VyRGF0YSxcbiAgICAgIGJsb2NrRGV2aWNlczogW1xuICAgICAgICB7XG4gICAgICAgICAgZGV2aWNlTmFtZTogJy9kZXYveHZkYScsXG4gICAgICAgICAgdm9sdW1lOiBlYzIuQmxvY2tEZXZpY2VWb2x1bWUuZWJzKDIwLCB7XG4gICAgICAgICAgICB2b2x1bWVUeXBlOiBlYzIuRWJzRGV2aWNlVm9sdW1lVHlwZS5HUDMsXG4gICAgICAgICAgICBkZWxldGVPblRlcm1pbmF0aW9uOiB0cnVlLFxuICAgICAgICAgIH0pLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9KTtcblxuICAgIC8vIFRhZyB0aGUgaW5zdGFuY2VcbiAgICBjZGsuVGFncy5vZih0aGlzLmRlcGxveW1lbnRJbnN0YW5jZSkuYWRkKCdQcm9qZWN0JywgJ01hdGVyaWFsUmVjb2duaXRpb25TZXJ2aWNlJyk7XG4gICAgY2RrLlRhZ3Mub2YodGhpcy5kZXBsb3ltZW50SW5zdGFuY2UpLmFkZCgnRW52aXJvbm1lbnQnLCAnRGV2ZWxvcG1lbnQnKTtcbiAgICBjZGsuVGFncy5vZih0aGlzLmRlcGxveW1lbnRJbnN0YW5jZSkuYWRkKCdQdXJwb3NlJywgJ0RlcGxveW1lbnQnKTtcbiAgfVxufVxuIl19